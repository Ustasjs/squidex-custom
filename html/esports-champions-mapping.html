<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <script src="https://cloud.squidex.io/scripts/editor-sdk.js"></script>
    <!-- change reat to production version -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- support for JSX in the type="text/babel" sript -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/react-hook-form@6.15.4/dist/index.umd.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cloud.squidex.io/build/app.css" />

    <style>
      body {
        background: none;
      }

      #root__title {
        display: none;
      }

      #editor {
        min-height: 350px;
      }

      .error {
        color: red;
      }
    </style>
  </head>

  <body>
    <div id="editor"></div>

    <script type="text/babel">
      const field = new SquidexFormField();

      function Editor() {
        const squidexFormValue = field.getFormValue();
        const initialValue = _.get(squidexFormValue, 'matchDataMaping.iv');
        const [isDisabled, setIsDisabled] = React.useState(false);
        const [value, setValue] = React.useState(initialValue || undefined);
        const [context, setContext] = React.useState(null);
        console.log('squidexFormValue', squidexFormValue);
        const [championsData, setChampionsData] = React.useState(null);
        const [matchData, setMatchData] = React.useState(null);
        const [isMatchDataLoading, setIsMatchDataLoading] = React.useState(false);
        const [matchDataError, setMatchDataError] = React.useState(null);
        console.log('championsData', championsData);
        console.log('matchData', matchData);

        const gameHash = _.get(squidexFormValue, 'gameHash.iv');
        const gameId = _.get(squidexFormValue, 'gameId.iv');
        const region = _.get(squidexFormValue, 'region.iv');
        const authorizationCookie = _.get(squidexFormValue, 'authorizationCookie.iv');

        console.log('gameHash', gameHash);
        console.log('gameId', gameId);
        console.log('region', region);
        console.log('authorizationCookie', authorizationCookie);

        field.onInit(intializedContext => {
          console.log('intializedContext', intializedContext);
          setContext(intializedContext);
        });

        const { register, handleSubmit, errors, control } = ReactHookForm.useForm();
        const onSubmit = data => {
          console.log(data);
        }

        React.useEffect(function () {
          field.onDisabled(function (disabled) {
            setIsDisabled(disabled);
          });

          field.onValueChanged(function (value) {
            setValue(value);
          });
        }, []);

        const getMatchData = React.useCallback(() => {
          if (gameId && region && authorizationCookie && context) {
            setIsMatchDataLoading(true);
            fetch(`https://dev-lol-backend-esports-dev-esports-http.us.moba.live/v1/matches/${region}/${gameId}`, {
              headers: {
                Authorization: `Bearer ${context.user.user.access_token}`,
              },
            })
              .then(response => {
                return response.json();
              })
              .then(parsedData => {
                console.log('parsedData', parsedData)
                setMatchData(parsedData);
                const participants = _.get(parsedData, 'Data.participants');
                return participants.map(participant => participant.championId);
              })
              .then(participants => {
                const filterValue = participants.reduce((acc, element) => {
                  acc = `${acc}, ${element}`;
                  return acc;
                }, '')
                const filter = `$filter=items/data/riotId/iv in (${filterValue})`;
                return fetch(`${context.apiUrl}/content/esports-v1/esports-games-v1/?${filter}`, {
                  headers: {
                    Authorization: `Bearer ${context.user.user.access_token}`,
                  },
                })
              })
              .then(response => {
                return response.json();
              })
              .then(parsedData => {
                setIsMatchDataLoading(false);
                setChampionsData(parsedData);
              })
              .catch(error => {
                setMatchDataError(error);
                console.error(error);
              });
          }  
        }, [gameId, region, authorizationCookie, context]);

        if (!gameId || !region || !authorizationCookie) {
          return (
            <div>Please fill out all required fields</div>
          );
        }

        if (matchDataError) {
          <div className="error">
            <div>Oops, something went wrong!</div>
            <div>{matchDataError}</div>
          </div>
        }

        if (!matchData && !matchDataError) {
          return (
            <div>
              <button onClick={getMatchData} isDisabled={isMatchDataLoading} type="button">Load match data</button>
              {isMatchDataLoading && 'loading...'}
            </div>
          )}

          return 'Oups';
        }

      ReactDOM.render(React.createElement(Editor), document.getElementById('editor'));
    </script>
  </body>
</html>
