<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <script src="https://cloud.squidex.io/scripts/editor-sdk.js"></script>
    <!-- change reat to production version -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- support for JSX in the type="text/babel" sript -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/react-hook-form@6.15.4/dist/index.umd.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cloud.squidex.io/build/app.css" />

    <style>
      body {
        background: none;
      }

      #root__title {
        display: none;
      }

      #editor {
        min-height: 350px;
      }

      .error {
        color: red;
      }

      .form-group {
        margin-bottom: 25px;
        position: relative;
      }

      .form-error {
        position: absolute;
        left: 0;
        top: 33px;
      }
    </style>
  </head>

  <body>
    <div id="editor"></div>

    <script type="text/babel">
      const field = new SquidexFormField();

      function getMatchData(region, gameId, gameHash) {
        return fetch(`https://esports.int.mobalytics.gg/api/YFFqpzF7QXbsunj6VyXtn8vxPtY3N6/v1/esports/matches/${region}/${gameId}${gameHash ? `?hash=${gameHash}` : ''}`, {
          method: 'GET',
          mode: 'cors',
        }).then(response => {
          return response.json();
        })
      }

      function getChampions(participants, context) {
        const filterValue = participants.reduce((acc, element) => {
          if (acc === '') {
            return `${element}`;
          }
          acc = `${acc}, ${element}`;
          return acc;
        }, '')
        const filter = `$filter=data/riotId/iv in (${filterValue})`;
        return fetch(`${context.apiUrl}/content/league-v1/champions-v1/?${filter}`, {
          headers: {
            Authorization: `Bearer ${context.user.user.access_token}`,
          },
        }).then(response => {
          return response.json();
        })
      }

      function getPlayers(context) {
        return fetch(`${context.apiUrl}/content/esports-v1/esports-players-v1/`, {
          headers: {
            Authorization: `Bearer ${context.user.user.access_token}`,
          },
        }).then(response => {
          return response.json();
        })
      }

      function Editor() {
        const squidexFormValue = field.getFormValue();
        const initialValue = _.get(squidexFormValue, 'matchDataMaping.iv');
        const [isDisabled, setIsDisabled] = React.useState(false);
        const [value, setValue] = React.useState(initialValue || undefined);
        const [context, setContext] = React.useState(null);
        const [championsData, setChampionsData] = React.useState(null);
        const [matchData, setMatchData] = React.useState(null);
        const [playersData, setPlayersData] = React.useState(null);
        const [isMatchDataLoading, setIsMatchDataLoading] = React.useState(false);
        const [matchDataError, setMatchDataError] = React.useState(null);

        const gameHash = _.get(squidexFormValue, 'gameHash.iv');
        const gameId = _.get(squidexFormValue, 'gameId.iv');
        const region = _.get(squidexFormValue, 'region.iv');

        field.onInit(intializedContext => {
          setContext(intializedContext);
        });

        const { register, handleSubmit, errors, control } = ReactHookForm.useForm();
        const onSubmit = data => {
          console.log(data);
        }

        React.useEffect(function () {
          field.onDisabled(function (disabled) {
            setIsDisabled(disabled);
          });

          field.onValueChanged(function (value) {
            setValue(value);
          });
        }, []);

        const formattedChampionsData = React.useMemo(function () {
          if (championsData) {
            return championsData.items.map(championData => _.get(championData, 'data.slug.iv'));
          }
          return null;
        }, [championsData]);

        const getMatchDataCallback = React.useCallback(() => {
          if (gameId && region && context) {
            setIsMatchDataLoading(true);
            Promise.all([getMatchData(region, gameId, gameHash), getPlayers(context)])
              .then(([parsedMatchData, parsedPlayersData]) => {
                setMatchData(parsedMatchData);
                setPlayersData(parsedPlayersData);
                const participants = _.get(parsedMatchData, 'Data.participants');
                return participants.map(participant => participant.championId);
              })
              .then(participants => {
                return getChampions(participants, context);
              })
              .then(parsedData => {
                setIsMatchDataLoading(false);
                setChampionsData(parsedData);
              })
              .catch(error => {
                setMatchDataError(error.message);
                console.error(error);
              });
          }  
        }, [gameId, gameHash, region, context]);

        if (!gameId || !region) {
          return (
            <div>Please fill out all required fields</div>
          );
        }

        if (matchDataError) {
          return ( <div className="error">
            <div>Oops, something went wrong!</div>
            <div>{matchDataError}</div>
          </div>)
        }

        if ((!championsData || !matchData) && !matchDataError) {
          return (
            <div>
              <button onClick={getMatchDataCallback} disabled={isMatchDataLoading} type="button">Load match data</button>
              {isMatchDataLoading && 'loading...'}
            </div>
          )}

          console.log('formattedChampionsData', formattedChampionsData);
          console.log('playersData', playersData);

          return formattedChampionsData && (
            <form onSubmit={handleSubmit(onSubmit)}>
              {formattedChampionsData.map(champion => (
                <div key={champion}>
                  <div className="form-group">
                    <span style={{ marginRight: '10px' }}>{champion}</span>
                    <input name={`${champion} player`} ref={register({ required: true })} />
                    {errors[`${champion} player`] && <div className="error form-error">This field is required</div>}
                  </div>
                </div>
              ))}
              
              <button type="submit">SAVE</button>
            </form>
          );
        }

      ReactDOM.render(React.createElement(Editor), document.getElementById('editor'));
    </script>
  </body>
</html>
